<?php
require_once('wp-config.php');

// ÐœÐ°ÑÑÐ¸Ð² ÑÑ‚Ð°Ñ‚ÐµÐ¹ Ñ Ð¸Ñ… Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ€ÐµÐ²Ð¸Ð·Ð¸ÑÐ¼Ð¸
$articles_to_restore = [
    2527 => 4863, 2526 => 4864, 2525 => 4865, 2524 => 4866, 2523 => 4867, 2522 => 4868, 2520 => 4870, 2519 => 4871, 2518 => 4872, 2517 => 4873, 2516 => 4874, 2515 => 4875, 2513 => 4877, 2512 => 4878, 2510 => 4880, 2508 => 4882, 2506 => 4884, 2505 => 4885, 2504 => 4886, 2503 => 4887, 2502 => 4888, 2501 => 4889, 2499 => 4891, 2498 => 4892, 2497 => 4893, 2496 => 4894, 2495 => 4895, 2494 => 4896, 2493 => 4897, 2492 => 4898, 2490 => 4900, 2489 => 4901, 2487 => 4903, 2486 => 4904, 2485 => 4905, 2484 => 4906, 2482 => 4908, 2481 => 4909, 2478 => 4912, 2477 => 4913, 2476 => 4914, 2474 => 4916, 2473 => 4917, 2470 => 4920, 2468 => 4922, 2466 => 4924, 2465 => 4925, 2463 => 4927, 2461 => 4929, 2460 => 4930, 2456 => 4934, 2455 => 4935, 2454 => 4936, 2452 => 4938, 2450 => 4940, 2449 => 4941, 2448 => 4942, 2445 => 4945, 2444 => 4946, 2442 => 4948, 2441 => 4949, 2440 => 4950, 2439 => 4951, 2437 => 4953, 2436 => 4954, 2435 => 4955, 2434 => 4956, 2433 => 4957, 2432 => 4958, 2430 => 4960, 2429 => 4961, 2428 => 4962, 2426 => 4964, 2425 => 4965, 2423 => 4966, 2422 => 4967, 2421 => 4968, 2420 => 4969, 2046 => 4971
];

echo "=== Ð’ÐžÐ¡Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•ÐÐ˜Ð• ÐžÐ¡Ð¢ÐÐ’Ð¨Ð˜Ð¥Ð¡Ð¯ Ð¡Ð¢ÐÐ¢Ð•Ð™ ===\n";
echo "Ð’ÑÐµÐ³Ð¾ ÑÑ‚Ð°Ñ‚ÐµÐ¹ Ð´Ð»Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ: " . count($articles_to_restore) . "\n\n";

$success_count = 0;
$error_count = 0;
$results = [];

foreach ($articles_to_restore as $post_id => $revision_id) {
    echo "Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑŒÐ¸ ID: $post_id (Ñ€ÐµÐ²Ð¸Ð·Ð¸Ñ: $revision_id)\n";
    
    try {
        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ ÑÑ‚Ð°Ñ‚ÑŒÑŽ
        $current_post = get_post($post_id);
        if (!$current_post) {
            echo "  âŒ Ð¡Ñ‚Ð°Ñ‚ÑŒÑ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°\n";
            $error_count++;
            $results[] = "ID $post_id: Ð¡Ñ‚Ð°Ñ‚ÑŒÑ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°";
            continue;
        }
        
        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ€ÐµÐ²Ð¸Ð·Ð¸ÑŽ
        $revision = get_post($revision_id);
        if (!$revision) {
            echo "  âŒ Ð ÐµÐ²Ð¸Ð·Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°\n";
            $error_count++;
            $results[] = "ID $post_id: Ð ÐµÐ²Ð¸Ð·Ð¸Ñ $revision_id Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°";
            continue;
        }
        
        echo "  ðŸ“„ Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº: " . substr($current_post->post_title, 0, 50) . "...\n";
        echo "  ðŸ“Š Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð»Ð¸Ð½Ð°: " . strlen($current_post->post_content) . " ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²\n";
        echo "  ðŸ“Š Ð”Ð»Ð¸Ð½Ð° Ñ€ÐµÐ²Ð¸Ð·Ð¸Ð¸: " . strlen($revision->post_content) . " ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²\n";
        
        // ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ ÑÑ‚Ð°Ñ‚ÑŒÐ¸
        $current_content = $current_post->post_content;
        $intro_section_end = strpos($current_content, '</section>');
        
        $new_content = '';
        if ($intro_section_end !== false) {
            // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð¾ ÐºÐ¾Ð½Ñ†Ð° intro-section
            $structure_part = substr($current_content, 0, $intro_section_end);
            $new_content = $structure_part . "\n\n" . $revision->post_content;
        } else {
            // Ð•ÑÐ»Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, Ð·Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð²ÐµÑÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚
            $new_content = $revision->post_content;
        }
        
        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑŒÑŽ
        $update_result = wp_update_post(array(
            'ID' => $post_id,
            'post_content' => $new_content
        ));
        
        if ($update_result && !is_wp_error($update_result)) {
            echo "  âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°! ÐÐ¾Ð²Ð°Ñ Ð´Ð»Ð¸Ð½Ð°: " . strlen($new_content) . " ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²\n";
            $success_count++;
            $results[] = "ID $post_id: Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°";
        } else {
            echo "  âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸\n";
            if (is_wp_error($update_result)) {
                echo "  ðŸ” ÐžÑˆÐ¸Ð±ÐºÐ°: " . $update_result->get_error_message() . "\n";
            }
            $error_count++;
            $results[] = "ID $post_id: ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸";
        }
        
    } catch (Exception $e) {
        echo "  âŒ Ð˜ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ: " . $e->getMessage() . "\n";
        $error_count++;
        $results[] = "ID $post_id: Ð˜ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ - " . $e->getMessage();
    }
    
    echo "\n";
    
    // ÐŸÐ°ÑƒÐ·Ð° ÐºÐ°Ð¶Ð´Ñ‹Ðµ 10 ÑÑ‚Ð°Ñ‚ÐµÐ¹
    if (($success_count + $error_count) % 10 == 0) {
        echo "â¸ï¸ ÐŸÐ°ÑƒÐ·Ð° 2 ÑÐµÐºÑƒÐ½Ð´Ñ‹...\n";
        sleep(2);
    }
}

// ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÐµÑˆ
if (function_exists('wp_cache_flush')) {
    wp_cache_flush();
    echo "ðŸ§¹ ÐšÐµÑˆ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½\n";
}

echo "\n=== Ð˜Ð¢ÐžÐ“ÐžÐ’ÐÐ¯ Ð¡Ð¢ÐÐ¢Ð˜Ð¡Ð¢Ð˜ÐšÐ ===\n";
echo "âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾: $success_count\n";
echo "âŒ ÐžÑˆÐ¸Ð±Ð¾Ðº: $error_count\n";
echo "ðŸ“Š Ð’ÑÐµÐ³Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾: " . count($articles_to_restore) . "\n\n";

echo "=== Ð”Ð•Ð¢ÐÐ›Ð¬ÐÐ«Ð• Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð« ===\n";
foreach ($results as $result) {
    echo $result . "\n";
}

echo "\n=== Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž ===\n";
?>

