<?php
require_once('wp-config.php');

// Таблица совпадений из предыдущей работы (ID статьи => ID изображения)
$matches = array(
    3172 => 3177,
    3169 => 3170,
    3160 => 3161,
    3157 => 3158,
    3153 => 3154,
    3152 => 3181,
    3144 => 3145,
    3138 => 3140,
    3135 => 3136,
    3127 => 3184,
    3126 => 3128,
    3122 => 3123,
    3111 => 3112,
    3109 => 3187,
    3102 => 3128,
    3097 => 3098,
    3088 => 3090,
    3087 => 3095,
    3081 => 3082,
    3072 => 3073,
    3068 => 3070,
    3064 => 3075,
    3058 => 3191,
    3057 => 3059,
    3055 => 3194,
    3049 => 3194,
    3048 => 3050,
    3044 => 3045,
    3039 => 3042,
    3034 => 3035,
    3028 => 3031,
    3027 => 3029,
    3024 => 3025,
    3017 => 3018,
    3016 => 3197,
    3013 => 3014,
    3007 => 3008,
    2998 => 2999,
    2991 => 2992,
    2986 => 2988,
    2983 => 2985,
    2976 => 2977,
    2975 => 3200,
    2967 => 2971,
    2966 => 3198,
    2960 => 2961,
    2956 => 3208,
    2953 => 2957,
    2948 => 2951,
    2947 => 2949,
    2944 => 2945,
    2943 => 3205,
    2940 => 2941,
    2938 => 3209,
    2934 => 2936,
    2931 => 2935,
    2928 => 2929,
    2926 => 3210,
    2923 => 2924,
    2918 => 2919,
    2917 => 2921,
    2914 => 2915,
    2911 => 2912,
    2910 => 3203,
    2907 => 2908,
    2904 => 2905,
    2900 => 2901,
    2894 => 2898,
    2893 => 3211,
    2890 => 2891,
    2889 => 3212,
    2887 => 2896,
    2884 => 2885,
    2880 => 2881,
    2877 => 2878,
    2872 => 2875,
    2871 => 2873,
    2863 => 2866,
    2859 => 2860,
    2852 => 2853,
    2849 => 2850,
    2843 => 2847,
    2833 => 2837,
    2830 => 2831,
    2827 => 2828,
    2816 => 2817,
    2798 => 2818,
    2803 => 2804,
    2527 => 2594,
    2526 => 2597,
    2525 => 2654,
    2524 => 2651,
    2523 => 2632,
    2522 => 2631,
    2521 => 2705,
    2520 => 2737,
    2519 => 2736,
    2518 => 2738,
    2517 => 2739,
    2516 => 2734,
    2515 => 2733,
    2514 => 2732,
    2513 => 2730,
    2512 => 2719,
    2511 => 2709,
    2510 => 2704,
    2509 => 2698,
    2508 => 2692,
    2507 => 2681,
    2506 => 2702,
    2505 => 2690,
    2504 => 2682,
    2503 => 2689,
    2502 => 2697,
    2501 => 2680,
    2500 => 2670,
    2499 => 2718,
    2498 => 2710,
    2497 => 2706,
    2496 => 2700,
    2495 => 2685,
    2494 => 2694,
    2493 => 2676,
    2492 => 2667,
    2491 => 2663,
    2490 => 2688,
    2489 => 2728,
    2488 => 2727,
    2487 => 2703,
    2486 => 2708,
    2485 => 2696,
    2484 => 2687,
    2483 => 2722,
    2482 => 2726,
    2481 => 2711,
    2480 => 2742,
    2479 => 2740,
    2478 => 2743,
    2477 => 2744,
    2476 => 2695,
    2475 => 2657,
    2474 => 2652,
    2473 => 2745,
    2472 => 2746,
    2471 => 2747,
    2470 => 2731,
    2469 => 2729,
    2468 => 2714,
    2467 => 2683,
    2466 => 2674,
    2465 => 2691,
    2464 => 2748,
    2463 => 2672,
    2462 => 2749,
    2461 => 2715,
    2460 => 2666,
    2459 => 2678,
    2458 => 2725,
    2457 => 2724,
    2456 => 2720,
    2455 => 2716,
    2454 => 2669,
    2453 => 2664,
    2452 => 2658,
    2451 => 2750,
    2450 => 2649,
    2449 => 2717,
    2448 => 2713,
    2447 => 2686,
    2446 => 2668,
    2445 => 2661,
    2444 => 2639,
    2443 => 2660,
    2442 => 2721,
    2441 => 2751,
    2440 => 2655,
    2439 => 2633,
    2438 => 2648,
    2437 => 2693,
    2436 => 2650,
    2435 => 2656,
    2434 => 2675,
    2433 => 2679,
    2432 => 2673,
    2431 => 2699,
    2430 => 2653,
    2429 => 2662,
    2428 => 2684,
    2427 => 2677,
    2426 => 2707,
    2425 => 2753,
    2423 => 2701,
    2422 => 2723,
    2421 => 2577,
    2420 => 2659,
    2067 => 2758,
    2060 => 1636,
    2046 => 1684
);

$fixed_count = 0;
$already_correct_count = 0;
$no_image_found_count = 0;
$total_processed = 0;

echo "=== ИСПРАВЛЕНИЕ МИНИАТЮР ПО ТАБЛИЦЕ СОВПАДЕНИЙ ===\n\n";

foreach ($matches as $post_id => $image_id) {
    $total_processed++;
    $post_title = get_the_title($post_id);
    $post_date = get_the_date('Y-m-d', $post_id);
    
    // Проверяем, существует ли статья
    if (!$post_title) {
        echo "Пропущена статья ID $post_id - статья не найдена.\n";
        $no_image_found_count++;
        continue;
    }
    
    // Проверяем, существует ли изображение
    $image_title = get_the_title($image_id);
    if (!$image_title) {
        echo "Пропущена статья ID $post_id ($post_date): '$post_title' - изображение ID $image_id не найдено.\n";
        $no_image_found_count++;
        continue;
    }
    
    // Получаем текущий _thumbnail_id
    $current_thumbnail_id = get_post_meta($post_id, '_thumbnail_id', true);
    
    // Проверяем, нужно ли обновлять
    if ($current_thumbnail_id == $image_id) {
        echo "✓ Статья ID $post_id ($post_date): '$post_title' - уже имеет правильное изображение ID $image_id.\n";
        $already_correct_count++;
        continue;
    }
    
    // Обновляем _thumbnail_id
    update_post_meta($post_id, '_thumbnail_id', $image_id);
    
    // Получаем информацию об изображении
    $image_path = get_attached_file($image_id);
    $upload_dir = wp_upload_dir();
    $base_dir = $upload_dir['basedir'];
    $base_url = $upload_dir['baseurl'];
    
    if ($image_path && file_exists($image_path)) {
        // Получаем правильный путь к файлу
        $relative_path = str_replace($base_dir . '/', '', $image_path);
        $correct_url = $base_url . '/' . $relative_path;
        
        // Обновляем _wp_attached_file
        update_post_meta($image_id, '_wp_attached_file', $relative_path);
        
        // Обновляем GUID
        wp_update_post(array(
            'ID' => $image_id,
            'guid' => $correct_url
        ));
        
        // Регенерируем миниатюры
        wp_generate_attachment_metadata($image_id, $image_path);
        
        echo "✔ Исправлена миниатюра для статьи ID $post_id ($post_date): '$post_title' (Изображение ID: $image_id)\n";
        $fixed_count++;
    } else {
        echo "✗ Файл изображения не найден для статьи ID $post_id ($post_date): '$post_title' (Изображение ID: $image_id)\n";
        $no_image_found_count++;
    }
}

echo "\n=== РЕЗУЛЬТАТЫ ИСПРАВЛЕНИЯ ===\n";
echo "Исправлено миниатюр: $fixed_count\n";
echo "Уже имели правильные изображения: $already_correct_count\n";
echo "Не найдено подходящих изображений: $no_image_found_count\n";
echo "Всего обработано статей: $total_processed\n";

// Очищаем кэш
wp_cache_flush();
echo "\nКэш очищен.\n";
?>
