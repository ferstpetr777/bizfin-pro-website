<?php
/**
 * –û—Ç–ª–∞–¥–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–∫—É–ø–∫–∞—Ö
 * Company Rating Checker - Debug Zakupki Data
 */

// –ü–æ–¥–∫–ª—é—á–∞–µ–º WordPress
require_once('../../../wp-config.php');

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–∞–≥–∏–Ω
require_once('company-rating-checker.php');

echo "üîç –û–¢–õ–ê–î–ö–ê –î–ê–ù–ù–´–• –û –ì–û–°–ó–ê–ö–£–ü–ö–ê–•\n";
echo "================================\n\n";

$test_inn = '5260482041';
echo "üìã –ò–ù–ù –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: {$test_inn}\n";
echo "‚è∞ –í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: " . date('Y-m-d H:i:s') . "\n\n";

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –ø–ª–∞–≥–∏–Ω–∞
$plugin = new CompanyRatingChecker();
$reflection = new ReflectionClass($plugin);

echo "üöÄ –ü–†–û–í–ï–†–ö–ê –î–ê–ù–ù–´–• –û –ó–ê–ö–£–ü–ö–ê–•...\n";
echo "=================================\n\n";

// 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥ get_zakupki_data
echo "1Ô∏è‚É£ –ü–†–Ø–ú–û–ô –í–´–ó–û–í get_zakupki_data:\n";
echo "----------------------------------\n";
try {
    $get_zakupki_data_method = $reflection->getMethod('get_zakupki_data');
    $get_zakupki_data_method->setAccessible(true);
    $zakupki_data = $get_zakupki_data_method->invoke($plugin, $test_inn);
    
    if ($zakupki_data && !is_wp_error($zakupki_data)) {
        echo "   ‚úÖ –î–∞–Ω–Ω—ã–µ –æ –∑–∞–∫—É–ø–∫–∞—Ö –ø–æ–ª—É—á–µ–Ω—ã:\n";
        echo "   üìä –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤: " . ($zakupki_data['total_contracts'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω–æ') . "\n";
        echo "   üí∞ –û–±—â–∞—è —Å—É–º–º–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤: " . number_format($zakupki_data['total_amount'] ?? 0, 0, ',', ' ') . " —Ä—É–±.\n";
        echo "   üìà –ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤: " . ($zakupki_data['active_contracts'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω–æ') . "\n";
        echo "   ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤: " . ($zakupki_data['completed_contracts'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω–æ') . "\n";
        echo "   üìä –°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞: " . number_format($zakupki_data['avg_contract_amount'] ?? 0, 0, ',', ' ') . " —Ä—É–±.\n";
        echo "   üéØ –†–µ–ø—É—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π –±–∞–ª–ª: " . ($zakupki_data['reputation_score'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω') . "\n";
        echo "   üîç –ò—Å—Ç–æ—á–Ω–∏–∫: " . ($zakupki_data['source'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω') . "\n";
        echo "   üìÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: " . ($zakupki_data['last_updated'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω–æ') . "\n\n";
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏
        if (isset($zakupki_data['sources_checked'])) {
            echo "   üìã –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏:\n";
            foreach ($zakupki_data['sources_checked'] as $source_name => $source_info) {
                $status = $source_info['available'] ? '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                echo "      - {$source_name}: {$status} ({$source_info['url']})\n";
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–∫—Ç–æ—Ä—ã —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
        if (isset($zakupki_data['reputation_factors'])) {
            echo "\n   üìã –§–∞–∫—Ç–æ—Ä—ã —Ä–µ–ø—É—Ç–∞—Ü–∏–∏:\n";
            foreach ($zakupki_data['reputation_factors'] as $factor) {
                echo "      - {$factor}\n";
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
        if (isset($zakupki_data['contracts']) && is_array($zakupki_data['contracts'])) {
            echo "\n   üìã –î–µ—Ç–∞–ª–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤:\n";
            foreach ($zakupki_data['contracts'] as $i => $contract) {
                echo "      –ö–æ–Ω—Ç—Ä–∞–∫—Ç " . ($i + 1) . ":\n";
                echo "        - –ù–æ–º–µ—Ä: " . ($contract['number'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω') . "\n";
                echo "        - –°—É–º–º–∞: " . number_format($contract['amount'] ?? 0, 0, ',', ' ') . " —Ä—É–±.\n";
                echo "        - –°—Ç–∞—Ç—É—Å: " . ($contract['status'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω') . "\n";
                echo "        - –ó–∞–∫–∞–∑—á–∏–∫: " . ($contract['customer'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω') . "\n";
            }
        } else {
            echo "\n   ‚ö†Ô∏è –î–µ—Ç–∞–ª–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç\n";
        }
        
    } else {
        echo "   ‚ùå –î–∞–Ω–Ω—ã–µ –æ –∑–∞–∫—É–ø–∫–∞—Ö –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã\n";
        if (is_wp_error($zakupki_data)) {
            echo "   –û—à–∏–±–∫–∞: " . $zakupki_data->get_error_message() . "\n";
        }
    }
} catch (Exception $e) {
    echo "   ‚ùå –û—à–∏–±–∫–∞: " . $e->getMessage() . "\n";
}
echo "\n";

// 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–∫—É–ø–æ–∫
echo "2Ô∏è‚É£ –ù–ê–°–¢–†–û–ô–ö–ò –ó–ê–ö–£–ü–û–ö:\n";
echo "---------------------\n";
echo "   üîß –ó–∞–∫—É–ø–∫–∏ –≤–∫–ª—é—á–µ–Ω—ã: " . (get_option('crc_zakupki_enabled', 1) ? '–î–ê' : '–ù–ï–¢') . "\n";
echo "   üîë API –∫–ª—é—á –∑–∞–∫—É–ø–æ–∫: " . (get_option('crc_zakupki_api_key', '') ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω') . "\n";
echo "   üìä –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏: " . (get_option('crc_debug_mode', 0) ? '–í–∫–ª—é—á–µ–Ω' : '–û—Ç–∫–ª—é—á–µ–Ω') . "\n\n";

// 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
echo "3Ô∏è‚É£ –ü–†–û–í–ï–†–ö–ê –ü–†–Ø–ú–´–• –ó–ê–ü–†–û–°–û–í –ö –ò–°–¢–û–ß–ù–ò–ö–ê–ú:\n";
echo "==========================================\n";

// –ü—Ä–æ–≤–µ—Ä—è–µ–º zakupki.gov.ru
echo "   üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ zakupki.gov.ru:\n";
$zakupki_url = 'https://zakupki.gov.ru/epz/order/quicksearch/search.html';
$zakupki_response = wp_remote_get($zakupki_url, array('timeout' => 10, 'sslverify' => false));
if (!is_wp_error($zakupki_response)) {
    $code = wp_remote_retrieve_response_code($zakupki_response);
    echo "      - –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: {$code}\n";
    if ($code === 200) {
        echo "      - ‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω\n";
    } else {
        echo "      - ‚ùå –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–∫–æ–¥: {$code})\n";
    }
} else {
    echo "      - ‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " . $zakupki_response->get_error_message() . "\n";
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º clearspending.ru
echo "\n   üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ clearspending.ru:\n";
$clearspending_url = 'https://clearspending.ru/';
$clearspending_response = wp_remote_get($clearspending_url, array('timeout' => 10, 'sslverify' => false));
if (!is_wp_error($clearspending_response)) {
    $code = wp_remote_retrieve_response_code($clearspending_response);
    echo "      - –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: {$code}\n";
    if ($code === 200) {
        echo "      - ‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω\n";
    } else {
        echo "      - ‚ùå –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–∫–æ–¥: {$code})\n";
    }
} else {
    echo "      - ‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " . $clearspending_response->get_error_message() . "\n";
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º goszakupki.ru
echo "\n   üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ goszakupki.ru:\n";
$goszakupki_url = 'https://goszakupki.ru/';
$goszakupki_response = wp_remote_get($goszakupki_url, array('timeout' => 10, 'sslverify' => false));
if (!is_wp_error($goszakupki_response)) {
    $code = wp_remote_retrieve_response_code($goszakupki_response);
    echo "      - –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: {$code}\n";
    if ($code === 200) {
        echo "      - ‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω\n";
    } else {
        echo "      - ‚ùå –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–∫–æ–¥: {$code})\n";
    }
} else {
    echo "      - ‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " . $goszakupki_response->get_error_message() . "\n";
}

echo "\n";

// 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
echo "4Ô∏è‚É£ –ü–†–û–í–ï–†–ö–ê –≠–í–†–ò–°–¢–ò–ß–ï–°–ö–û–ì–û –ê–ù–ê–õ–ò–ó–ê:\n";
echo "====================================\n";
echo "   üîç –ê–Ω–∞–ª–∏–∑ –ò–ù–ù –¥–ª—è –∑–∞–∫—É–ø–æ–∫:\n";
echo "      - –ò–ù–ù: {$test_inn}\n";
echo "      - –î–ª–∏–Ω–∞: " . strlen($test_inn) . " —Ü–∏—Ñ—Ä\n";
echo "      - –†–µ–≥–∏–æ–Ω: " . substr($test_inn, 0, 2) . "\n";
echo "      - –û–ö–í–≠–î —Ñ–∞–∫—Ç–æ—Ä: " . (substr($test_inn, 0, 2) == '52' ? 'IT/–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏' : '–î—Ä—É–≥–∏–µ –æ—Ç—Ä–∞—Å–ª–∏') . "\n";
echo "      - –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ñ–∞–∫—Ç–æ—Ä: " . (strlen($test_inn) == 10 ? '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ' : '–ò–ü') . "\n\n";

// 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–º–ø–∞–Ω–∏–∏
echo "5Ô∏è‚É£ –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –ö–û–ú–ü–ê–ù–ò–ò:\n";
echo "==========================\n";
try {
    $get_company_data_method = $reflection->getMethod('get_company_data');
    $get_company_data_method->setAccessible(true);
    $company_data = $get_company_data_method->invoke($plugin, $test_inn);
    
    if ($company_data && !is_wp_error($company_data)) {
        echo "   ‚úÖ –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã\n";
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∑–∞–∫—É–ø–∫–∞—Ö
        $company_data['zakupki'] = $zakupki_data;
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥
        $calculate_rating_method = $reflection->getMethod('calculate_company_rating');
        $calculate_rating_method->setAccessible(true);
        $rating_result = $calculate_rating_method->invoke($plugin, $company_data);
        
        if ($rating_result && isset($rating_result['factors']['zakupki'])) {
            $zakupki_factor = $rating_result['factors']['zakupki'];
            echo "   ‚úÖ –§–∞–∫—Ç–æ—Ä –∑–∞–∫—É–ø–æ–∫ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ:\n";
            echo "   üìä –ù–∞–∑–≤–∞–Ω–∏–µ: {$zakupki_factor['name']}\n";
            echo "   üìà –ë–∞–ª–ª: {$zakupki_factor['score']}/{$zakupki_factor['max_score']}\n";
            echo "   üìù –û–ø–∏—Å–∞–Ω–∏–µ: {$zakupki_factor['description']}\n\n";
        } else {
            echo "   ‚ùå –§–∞–∫—Ç–æ—Ä –∑–∞–∫—É–ø–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ\n";
        }
        
    } else {
        echo "   ‚ùå –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã\n";
    }
} catch (Exception $e) {
    echo "   ‚ùå –û—à–∏–±–∫–∞: " . $e->getMessage() . "\n";
}
echo "\n";

// 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º AJAX –æ—Ç–≤–µ—Ç
echo "6Ô∏è‚É£ –ü–†–û–í–ï–†–ö–ê AJAX –û–¢–í–ï–¢–ê:\n";
echo "========================\n";
try {
    // –ò–º–∏—Ç–∏—Ä—É–µ–º AJAX –∑–∞–ø—Ä–æ—Å
    $_POST['action'] = 'crc_get_company_rating';
    $_POST['inn'] = $test_inn;
    $_POST['nonce'] = wp_create_nonce('crc_nonce');
    
    // –í–∫–ª—é—á–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é
    ob_start();
    
    // –í—ã–∑—ã–≤–∞–µ–º AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    $plugin->ajax_get_company_rating();
    
    $response = ob_get_clean();
    $data = json_decode($response, true);
    
    if ($data && $data['success']) {
        echo "   ‚úÖ AJAX –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω\n";
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫—É–ø–∫–∞—Ö –≤ –æ—Ç–≤–µ—Ç–µ
        if (isset($data['data']['company']['zakupki'])) {
            echo "   ‚úÖ –î–∞–Ω–Ω—ã–µ –æ –∑–∞–∫—É–ø–∫–∞—Ö –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ AJAX –æ—Ç–≤–µ—Ç–µ\n";
            $zakupki_ajax = $data['data']['company']['zakupki'];
            echo "   üìä –ö–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –≤ AJAX: " . ($zakupki_ajax['total_contracts'] ?? 0) . "\n";
            echo "   üí∞ –°—É–º–º–∞ –≤ AJAX: " . number_format($zakupki_ajax['total_amount'] ?? 0, 0, ',', ' ') . " —Ä—É–±.\n";
        } else {
            echo "   ‚ùå –î–∞–Ω–Ω—ã–µ –æ –∑–∞–∫—É–ø–∫–∞—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ AJAX –æ—Ç–≤–µ—Ç–µ\n";
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–∫—Ç–æ—Ä—ã –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
        if (isset($data['data']['rating']['factors']['zakupki'])) {
            echo "   ‚úÖ –§–∞–∫—Ç–æ—Ä –∑–∞–∫—É–ø–æ–∫ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ AJAX\n";
        } else {
            echo "   ‚ùå –§–∞–∫—Ç–æ—Ä –∑–∞–∫—É–ø–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ AJAX\n";
        }
        
    } else {
        echo "   ‚ùå AJAX –∑–∞–ø—Ä–æ—Å –Ω–µ—É—Å–ø–µ—à–µ–Ω\n";
        echo "   –û—Ç–≤–µ—Ç: " . $response . "\n";
    }
    
} catch (Exception $e) {
    echo "   ‚ùå –û—à–∏–±–∫–∞ AJAX: " . $e->getMessage() . "\n";
}

echo "\n‚è∞ –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Ç–ª–∞–¥–∫–∏: " . date('Y-m-d H:i:s') . "\n";
echo "üéØ –û–¢–õ–ê–î–ö–ê –î–ê–ù–ù–´–• –û –ó–ê–ö–£–ü–ö–ê–• –ó–ê–í–ï–†–®–ï–ù–ê!\n";
echo "=======================================\n";
?>
