<?php
/**
 * Скрипт для запуска E2E теста
 */

// Подключаем WordPress
define('WP_USE_THEMES', false);
require_once('../../../wp-load.php');

// Пропускаем проверку прав доступа для тестирования
// if (!current_user_can('manage_options')) {
//     die('Недостаточно прав для выполнения теста');
// }

echo "=== Запуск E2E теста: 'Как работает банковская гарантия' ===\n\n";

// Проверяем доступность классов
if (!class_exists('BizFin_E2E_Test_Bank_Guarantee_Process')) {
    die("❌ Класс BizFin_E2E_Test_Bank_Guarantee_Process не найден\n");
}

if (!class_exists('BizFin_Dynamic_Modules_System')) {
    die("❌ Класс BizFin_Dynamic_Modules_System не найден\n");
}

if (!class_exists('BizFin_Integration_Manager')) {
    die("❌ Класс BizFin_Integration_Manager не найден\n");
}

echo "✓ Все необходимые классы доступны\n";

// Создаем экземпляр теста
$e2e_test = new BizFin_E2E_Test_Bank_Guarantee_Process();

// Параметры тестовой статьи
$test_params = [
    'keyword' => 'как работает банковская гарантия',
    'user_instruction' => 'Информационный; закупщики/юристы. Отстройка: BPMN‑диаграмма процесса с таймингом.',
    'table_of_contents' => [
        [
            'heading' => 'Этапы процесса банковской гарантии',
            'subheadings' => ['Запрос', 'Скоринг', 'Оферта', 'Договор', 'Выдача', 'Реестр', 'Сопровождение'],
            'key_points' => ['Последовательность этапов', 'Ключевые моменты каждого этапа', 'Взаимосвязь этапов'],
            'target_words' => 400
        ],
        [
            'heading' => 'Сроки оформления банковской гарантии',
            'subheadings' => ['Стандартные сроки', 'Ускоренные процедуры', 'Факторы влияния на сроки'],
            'key_points' => ['Временные рамки', 'Зависимости сроков', 'Оптимизация времени'],
            'target_words' => 350
        ],
        [
            'heading' => 'Точки отказов в процессе',
            'subheadings' => ['Финансовые риски', 'Документооборот', 'Соответствие требованиям'],
            'key_points' => ['Основные причины отказов', 'Способы предотвращения', 'Минимизация рисков'],
            'target_words' => 300
        ],
        [
            'heading' => 'Что ускоряет одобрение гарантии',
            'subheadings' => ['Качественная подготовка документов', 'Финансовая прозрачность', 'Репутация заявителя'],
            'key_points' => ['Факторы ускорения', 'Лучшие практики', 'Рекомендации экспертов'],
            'target_words' => 350
        ],
        [
            'heading' => 'BPMN-диаграмма процесса',
            'subheadings' => ['Визуализация процесса', 'Временные рамки', 'Ответственные лица'],
            'key_points' => ['Схема процесса', 'Тайминг операций', 'Контрольные точки'],
            'target_words' => 300
        ],
        [
            'heading' => 'Практические рекомендации',
            'subheadings' => ['Подготовка к процессу', 'Выбор банка-партнера', 'Оптимизация процедур'],
            'key_points' => ['Советы экспертов', 'Типичные ошибки', 'Эффективные стратегии'],
            'target_words' => 400
        ]
    ],
    'modules' => ['timeline', 'document_checklist'],
    'faq' => [
        [
            'question' => 'Сколько длится процесс получения банковской гарантии?',
            'answer' => 'Стандартный срок оформления банковской гарантии составляет от 3 до 10 рабочих дней. В ускоренном режиме возможно получение в течение 1-2 дней при наличии всех необходимых документов.'
        ],
        [
            'question' => 'Что делать, если контракт меняется после выдачи гарантии?',
            'answer' => 'При изменении условий контракта необходимо уведомить банк и при необходимости внести изменения в условия гарантии. Это может потребовать дополнительного согласования и документооборота.'
        ],
        [
            'question' => 'Можно ли ускорить процесс получения гарантии?',
            'answer' => 'Да, процесс можно ускорить за счет качественной подготовки документов, выбора надежного банка-партнера и предварительного скоринга. Некоторые банки предлагают ускоренные процедуры для проверенных клиентов.'
        ]
    ],
    'cta' => 'Ускорим выдачу — предварительный скоринг бесплатно'
];

echo "✓ Параметры теста загружены\n";
echo "Ключевое слово: " . $test_params['keyword'] . "\n";
echo "Модули: " . implode(', ', $test_params['modules']) . "\n\n";

// Запускаем тест
try {
    $result = $e2e_test->run_full_e2e_test($test_params);
    
    if ($result['success']) {
        echo "✅ E2E тест выполнен успешно!\n\n";
        echo "Результаты:\n";
        echo "- ID статьи: " . $result['post_id'] . "\n";
        echo "- URL статьи: " . $result['article_url'] . "\n";
        echo "- Количество слов: " . $result['word_count'] . "\n\n";
        
        echo "Статус интеграций:\n";
        foreach ($result['integrations_status'] as $key => $status) {
            echo "- " . $key . ": " . ($status ? "✅" : "❌") . "\n";
        }
        
        echo "\nСтатус модулей:\n";
        foreach ($result['modules_status'] as $key => $status) {
            echo "- " . $key . ": " . ($status ? "✅" : "❌") . "\n";
        }
        
        echo "\nЛог выполнения:\n";
        foreach ($result['test_log'] as $log) {
            echo $log . "\n";
        }
        
    } else {
        echo "❌ E2E тест не выполнен: " . $result['error'] . "\n";
        echo "\nЛог ошибок:\n";
        foreach ($result['test_log'] as $log) {
            echo $log . "\n";
        }
    }
    
} catch (Exception $e) {
    echo "❌ Критическая ошибка: " . $e->getMessage() . "\n";
}

echo "\n=== Тест завершен ===\n";
