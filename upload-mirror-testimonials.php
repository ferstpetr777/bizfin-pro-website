<?php
/**
 * Скрипт для загрузки благодарственных писем из галереи зеркального сайта в медиатеку WordPress
 */

// Подключаем WordPress
require_once('wp-config.php');
require_once('wp-load.php');

// Директория с файлами
$source_dir = '/var/www/bizfin_pro_r_usr/data/www/bizfin-pro.ru/downloads/testimonials-mirror/';

// Выбираем 12 самых больших файлов для загрузки
$files = glob($source_dir . 'gallery_testimonial_*.{png,jpg,jpeg}', GLOB_BRACE);

// Сортируем файлы по размеру (от большего к меньшему)
$files_with_size = [];
foreach ($files as $file) {
    $size = filesize($file);
    $files_with_size[] = ['file' => $file, 'size' => $size];
}

usort($files_with_size, function($a, $b) {
    return $b['size'] - $a['size'];
});

// Берем первые 12 файлов
$selected_files = array_slice($files_with_size, 0, 12);

// Описания для благодарственных писем (на основе данных с сайта)
$testimonials_descriptions = [
    'ООО «Асирис-Инвест»

«ООО Асирис-Инвест выражает искреннюю и глубокую признательность всему коллективу компании ООО Бизнес-финанс, а так же лично Наталье Никитиной за длительное и плодотворное сотрудничество. Мы очень высоко ценим сложившиеся между нами деловые отношения и взаимопонимание.

Хотим подчеркнуть высокий уровень профессионализма, ответственности и компетентности сотрудников компании. Рекомендуем ООО Бизнес-финанс как надежного партнера в сфере финансовых услуг.»',

    'ИП Михайлов В.И.

«Индивидуальный предприниматель Михайлов Вячеслав Игоревич выражает искреннюю благодарность ООО «Бизнес Финанс» за плодотворное сотрудничество. Особенно отмечаем профессионализм и оперативность в решении вопросов выпуска банковских гарантий с целью заключения государственных и муниципальных контрактов в сфере здравоохранения.

Мы верим в сохранение сложившихся деловых и дружеских отношений, надеемся на дальнейшее взаимовыгодное сотрудничество.»',

    'ООО «ПрофБетон»

«ООО ПрофБетон выражает благодарность ООО Бизнес-Финанс, а также Наталье Никитиной за профессионализм в своем деле, за помощь и подробную консультацию, за внимательность и честность в работе с нашей компанией.»',

    'ООО «Реконструкция»

«ООО Реконструкция выражает искреннюю благодарность ООО Бизнес-Финанс, а именно Альбине Ремизовой, за профессионализм в своем деле, за помощь и подробную консультацию, за внимательность и честность в работе с нашей компанией. Высочайший профессионализм и полная самоотдача позволяют решать сложные задачи.»',

    'ООО «Север-Сити»

«ООО Север-Сити выражает благодарность ООО Бизнес-Финанс, а также, в частности, Никитиной Наталье, за квалифицированную помощь в организации слаженной работы, а также за оперативное решение поставленных задач. Надеемся на дальнейшее плодотворное сотрудничество и желаем Вам успешного развития и достижения новых целей.»',

    'ООО ЧОП «Пантера»

«Общество с ограниченной ответственностью частное охранное предприятие Пантера выражает благодарность сотруднику компании ООО Бизнес-Финанс Ремизовой Альбине за добросовестное отношение, квалифицированную помощь и за оперативное решение поставленных задач.

Надеемся на дальнейшее плодотворное сотрудничество.»',

    'ООО «МПА-М»

«ООО МПА-М выражает благодарность компании ООО Бизнес Финанс, а также, в частности, Ремизовой Альбине за квалифицированную помощь в организации слаженной работы, а также за оперативное решение поставленных задач.

Надеемся на дальнейшее плодотворное сотрудничество и желаем Вам успешного развития и достижения новых целей.»',

    'ООО «Кубань-ГазГеоНефтедобыча»

«ООО «Кубань-ГазГеоНефтедобыча» выражает благодарность компании ООО «Бизнес Финанс» за профессиональную помощь в оформлении банковских гарантий и высокое качество предоставляемых услуг.

Особенно отмечаем оперативность и внимательность сотрудников компании при решении сложных вопросов. Рекомендуем ООО «Бизнес Финанс» как надежного партнера в сфере финансовых услуг.»',

    'ООО «ИНТЕКС»

«Общество с ограниченной ответственностью «ИНТЕКС» благодарит компанию ООО «Бизнес Финанс» за качественное и своевременное оказание услуг по оформлению банковских гарантий.

Профессионализм, ответственность и индивидуальный подход к каждому клиенту позволяют рекомендовать ООО «Бизнес Финанс» как надежного партнера в финансовой сфере.»',

    'ИП Болалайкин Александр Валериевич

«Индивидуальный предприниматель Болалайкин Александр Валериевич выражает благодарность компании ООО «Бизнес Финанс» за высокий уровень сервиса и профессиональный подход к решению задач.

Особенно ценим оперативность и качество предоставляемых услуг. Желаем компании дальнейшего развития и процветания.»',

    'ООО «ИСК ИНТЕГРАЛ»

«Общество с ограниченной ответственностью «Инновационная строительная компания «ИНТЕГРАЛ»» выражает благодарность ООО «Бизнес Финанс» за профессионализм, надежность и высокое качество услуг при подготовке и согласовании независимых гарантий.»',

    'ООО «Север-Сити» (второе письмо)

«ООО «Север-Сити» выражает искреннюю благодарность ООО «Бизнес Финанс» за качественное предоставление финансовых услуг и профессиональный подход к работе с клиентами.»'
];

echo "Начинаем загрузку благодарственных писем из галереи зеркального сайта...\n\n";

foreach ($selected_files as $index => $file_data) {
    $file_path = $file_data['file'];
    $filename = basename($file_path);
    $size_kb = round($file_data['size'] / 1024, 2);
    
    echo "Загружаем файл: {$filename} ({$size_kb} KB)\n";
    
    // Проверяем, не загружен ли уже этот файл
    $existing_attachment = get_posts([
        'post_type' => 'attachment',
        'meta_query' => [
            [
                'key' => '_wp_attached_file',
                'value' => basename($filename),
                'compare' => 'LIKE'
            ]
        ]
    ]);
    
    if (!empty($existing_attachment)) {
        echo "Файл {$filename} уже загружен, пропускаем...\n";
        continue;
    }
    
    // Подготавливаем данные для загрузки
    $upload_dir = wp_upload_dir();
    $file_array = [
        'name' => $filename,
        'tmp_name' => $file_path,
        'type' => mime_content_type($file_path),
        'error' => 0,
        'size' => $file_data['size']
    ];
    
    // Загружаем файл
    $attachment_id = media_handle_sideload($file_array, 0);
    
    if (is_wp_error($attachment_id)) {
        echo "Ошибка при загрузке {$filename}: " . $attachment_id->get_error_message() . "\n";
        continue;
    }
    
    // Получаем описание для этого файла
    $description = isset($testimonials_descriptions[$index]) ? $testimonials_descriptions[$index] : 'Благодарственное письмо от клиента ООО «Бизнес Финанс»';
    
    // Обновляем alt-текст и описание
    $alt_text = 'Благодарственное письмо от клиента ООО «Бизнес Финанс» (зеркальный сайт)';
    update_post_meta($attachment_id, '_wp_attachment_image_alt', $alt_text);
    
    wp_update_post([
        'ID' => $attachment_id,
        'post_content' => $description,
        'post_excerpt' => $alt_text
    ]);
    
    echo "Файл {$filename} успешно загружен (ID: {$attachment_id})\n";
    echo "Alt-текст: {$alt_text}\n\n";
}

echo "Загрузка завершена!\n";
?>
